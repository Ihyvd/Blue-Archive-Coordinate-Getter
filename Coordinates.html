<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Archive Coordinate Tool v1.4</title>
    
    <!-- 
    ================================================================================
    Blue Archive Coordinate Tool - Style Definitions
    ================================================================================
    This section contains all CSS styling for the coordinate tool interface.
    The styles are organized into logical sections for maintainability.
    
    Table of Contents:
    1. CSS Custom Properties (Theme Colors)
    2. Body and Animation Styles
    3. Container Styles
    4. Typography and Headers
    5. UI Component Styles
    6. Button Styles
    7. Note and Alert Styles
    ================================================================================
    -->
    <style>
        /**
         * Section 1: CSS Custom Properties (Theme Colors)
         * ================================================================================
         * Defines the Blue Archive color scheme used throughout the tool.
         * These variables make it easy to maintain consistent theming.
         */
        :root {
            /* Blue Archive damage type colors */
            --ba-explosion: rgb(167, 12, 25);
            --ba-pierce: rgb(178, 109, 31);
            --ba-mystic: rgb(33, 111, 156);
            --ba-sonic: rgb(148, 49, 165);
            --ba-normal: rgb(72, 85, 130);
            
            /* Glassmorphism effect colors */
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-text: rgba(0, 0, 0, 0.8);
            --glass-text-light: rgba(0, 0, 0, 0.6);
            --glass-accent: rgba(255, 255, 255, 0.3);
            --glass-button: rgba(255, 255, 255, 0.2);
            --glass-button-hover: rgba(255, 255, 255, 0.3);
            --glass-shadow: rgba(0, 0, 0, 0.1);
        }

        /**
         * Section 2: Body and Animation Styles
         * ================================================================================
         * Main body styling with animated gradient background.
         * The gradient shifts through Blue Archive damage type colors.
         */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            /* Animated gradient background using BA colors */
            background: linear-gradient(-45deg, 
                var(--ba-explosion), 
                var(--ba-pierce), 
                var(--ba-mystic), 
                var(--ba-sonic), 
                var(--ba-normal));
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        /* Gradient animation keyframes */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /**
         * Section 3: Container Styles
         * ================================================================================
         * Main content container with glassmorphism effect.
         * Uses backdrop-filter for the blurred glass appearance.
         */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 
                0 8px 32px var(--glass-shadow),
                inset 0 1px 0 var(--glass-border);
            position: relative;
        }

        /**
         * Section 4: Typography and Headers
         * ================================================================================
         * Styles for headings and text elements.
         */
        h1 {
            color: #2c3e50;
            margin-top: 0;
        }

        /**
         * Section 5: UI Component Styles
         * ================================================================================
         * Styles for various UI components like instructions, code blocks, etc.
         */
        #instructions {
            background-color: #eaf7ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }

        #instructions h2 {
            margin-top: 0;
            color: #2980b9;
        }

        #instructions ul {
            padding-left: 20px;
        }

        .code-block {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .bookmarklet-link {
            display: inline-block;
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 10px 0;
        }

        /**
         * Section 6: Button Styles
         * ================================================================================
         * Common button styling for test and copy buttons.
         */
        button {
            display: block;
            margin: 10px 0;
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .test-btn {
            background-color: #27ae60;
        }

        .copy-btn {
            background-color: #9b59b6;
        }

        /**
         * Section 7: Note and Alert Styles
         * ================================================================================
         * Styles for error notes and fix notes (alert boxes).
         */
        .error-note {
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        .error-note h3 {
            color: #d32f2f;
            margin-top: 0;
        }

        .fix-note {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        .fix-note h3 {
            color: #2e7d32;
            margin-top: 0;
        }
    </style>
</head>

<body>
    <!-- 
    ================================================================================
    Main Content Container
    ================================================================================
    Contains all the visible content of the page including:
    - Title and version information
    - Fix notes for version 1.4
    - Instructions for using the tool
    - Bookmarklet code container
    ================================================================================
    -->
    <div class="container">
        <h1>Blue Archive Coordinate Tool v1.4</h1>

        <!-- Version 1.4 Fix Notes -->
        <div class="fix-note">
            <h3>Fixed Issues in v1.4:</h3>
            <ul>
                <li>Fixed CSP (Content Security Policy) issues</li>
                <li>Fixed TrustedHTML assignment errors</li>
                <li>Replaced all innerHTML assignments with proper DOM manipulation</li>
                <li>Enhanced theater mode detection with multiple fallback checks</li>
                <li>Added stabilization period for fullscreen-to-normal transitions</li>
                <li>Fixed resolution ratio calculations when manually changing dimensions</li>
                <li>No scrolling or interaction needed - all transitions update instantly!</li>
            </ul>
        </div>

        <!-- Tool Instructions -->
        <div id="instructions">
            <h2>Information</h2>
            <ul>
                <li>Click "Activate Overlay" to place an overlay on the video</li>
                <li>Customize marker colors and sizes using the control panel</li>
                <li>Drag markers to adjust their position</li>
                <li>Edit coordinate values in the control panel</li>
                <li>Enter custom resolution values if needed and click "Apply"</li>
                <li>Hold Shift and click anywhere on the video to place markers</li>
                <li>Import coordinates from Blue Archive or export your current markers</li>
                <li>Left-clicks will pass through the overlay to interact with the video</li>
                <li>Lock the resolution to prevent automatic resizing</li>
                <li>Tool automatically adjusts when you zoom in/out of the page</li>
                <li>Values automatically update with 100-based ratio calculations</li>
            </ul>
        </div>

        <!-- Bookmarklet Code Container -->
        <div id="bookmarkletCode" class="code-block">
            <!-- Bookmarklet code will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- 
    ================================================================================
    JavaScript Section
    ================================================================================
    This script handles:
    1. DOM Content Loading
    2. Bookmarklet Code Generation
    3. Dynamic Content Insertion
    4. User Interface Creation
    
    The script waits for DOM to load before executing to ensure all elements
    are available for manipulation.
    ================================================================================
    -->
    <script>
        /**
         * Main Initialization Function
         * ================================================================================
         * Executes when the DOM is fully loaded.
         * Creates the bookmarklet code and inserts it into the page.
         */
        document.addEventListener('DOMContentLoaded', function() {
            /**
             * Bookmarklet Code String
             * ================================================================================
             * This variable contains the entire bookmarklet code that will be executed
             * when the user clicks the bookmarklet link. It's a self-contained script
             * that creates the coordinate tool overlay on any video page.
             * 
             * v1.4 Changes:
             * - Fixed CSP issues with DOM manipulation
             * - Fixed YouTube mode switching for instant updates
             * - Enhanced detection and update mechanisms
             * - Fixed resolution ratio calculations
             */
            var bookmarkletCode = `(function(){
if(window.baCT){alert('Tool already active');return}
window.baCT=1;
var s=document.createElement('style');
s.textContent='.ba-o{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(52,152,219,0.1);cursor:crosshair;z-index:10000;pointer-events:none}.ba-m{position:absolute;transform:translate(-50%,-50%);pointer-events:all;cursor:move;z-index:10001}.ba-d{width:3px;height:3px;background:red;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10002}.ba-r{border:1px solid #41b4ff;border-radius:50%;width:20px;height:20px;background:transparent;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10001;pointer-events:none}.ba-l{position:absolute;top:-24px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:2px 6px;border-radius:3px;font-size:12px;white-space:nowrap;pointer-events:none;z-index:10002}.ba-c{position:fixed!important;top:10px!important;right:10px!important;background:rgba(0,0,0,0.9)!important;color:white!important;padding:15px!important;border-radius:8px!important;width:320px!important;z-index:2147483647!important;font-family:Arial,sans-serif!important;font-size:12px!important;max-height:90vh!important;overflow-y:auto!important;box-shadow:0 4px 20px rgba(0,0,0,0.5)!important}.ba-c h3{margin-top:0!important;margin-bottom:12px!important;font-size:14px!important;display:flex!important;justify-content:space-between!important;align-items:center!important}.ba-b{background:#3498db!important;color:white!important;border:none!important;padding:6px 12px!important;border-radius:4px!important;cursor:pointer!important;margin-right:5px!important;font-size:12px!important}.ba-b:hover{background:#2980b9!important}.ba-cl{margin-top:10px;max-height:300px;overflow-y:auto}.ba-ci{background:rgba(255,255,255,0.1);padding:8px;margin-bottom:8px;border-radius:3px}.ba-ci h4{margin:0 0 5px 0;font-size:12px;display:flex;justify-content:space-between;align-items:center}.ba-del{background:#e74c3c!important;padding:2px 5px!important;font-size:10px!important}.ba-i{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}.ba-ig{display:flex;flex-direction:column;margin-bottom:5px}.ba-ig label{font-size:10px;margin-bottom:3px}.ba-ig input{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:4px;border-radius:3px;font-size:11px;width:100%;box-sizing:border-box}.ba-sc{margin-top:12px;background:rgba(52,152,219,0.1);padding:12px;border-radius:6px}.ba-ct{display:flex;flex-direction:column;margin-bottom:12px;width:100%}.ba-ct label{font-size:12px;margin-bottom:6px;font-weight:500}.ba-cr{display:flex;align-items:center;gap:8px;width:100%}.ba-cr input[type="range"]{flex:1}.ba-cr input[type="color"]{width:40px;height:30px;border:none;border-radius:4px;cursor:pointer;padding:0}.ba-cr span{min-width:45px;text-align:right;font-size:11px;color:#ccc}.ba-ie{display:flex;justify-content:space-between;margin-top:12px;gap:8px}.ba-ie .ba-b{flex:1;margin-right:0}.ba-im{display:none;position:fixed;z-index:2147483648;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}.ba-z{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.8);color:white;padding:8px 12px;border-radius:6px;font-size:11px;z-index:10003;pointer-events:none}.ba-ed{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:25px;border-radius:8px;z-index:2147483648;box-shadow:0 4px 20px rgba(0,0,0,0.3);min-width:320px}.ba-eo{background:#f7f7f7;padding:15px;margin-bottom:15px;border-radius:5px;cursor:pointer;border:2px solid transparent;transition:all 0.2s}.ba-eo:hover{border-color:#3498db;background:#eaf7ff}.ba-eo h4{margin:0 0 5px 0;color:#2c3e50}.ba-eo p{margin:0;font-size:12px;color:#666}.ba-eb{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}.ba-rp{position:absolute;background:rgba(0,0,0,0.8);padding:10px;border-radius:5px;color:white;z-index:10001;display:flex;align-items:center;pointer-events:all}';
document.head.appendChild(s);
var M=[],C=0,D=0,S=null,dx=0,dy=0,L=0,rs=20,ds=3,rc="#41b4ff",dc="#ff0000",o,c,rp,im,z,ed,wi,hi,lr,fs=0,vc=null,vr=null,sh=0,mx=0,my=0,cz=1,zi,ro=null,mo=null,ut=null,ifu=0,lvm=null,vpr=null,yt=0,ytut=null,ytft=0,raf=null,udt=0,fuu=0,yro=null,pmu=0,sut=null,pfs=0;
function fv(){var v=document.querySelector('video');if(v)return v;var iframe=document.querySelector('iframe[src*="youtube"]');if(iframe&&iframe.contentDocument){v=iframe.contentDocument.querySelector('video')}return v||null}
vc=fv();if(!vc){alert('No video found');window.baCT=0;return}
vr=vc.getBoundingClientRect();
function ce(t){return document.createElement(t)}
function cl(e){while(e.firstChild)e.removeChild(e.firstChild)}
function uz(){if(z)z.textContent='Zoom: '+Math.round(cz*100)+'%'}
function ifsm(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}
function dytm(){if(!window.location.hostname.includes('youtube'))return null;var ytpc=document.querySelector('ytd-watch-flexy');if(!ytpc)return null;if(ifsm())return'fullscreen';var tm=ytpc.hasAttribute('theater')||ytpc.classList.contains('ytd-watch-flexy--theater')||ytpc.hasAttribute('theater-requested')||ytpc.hasAttribute('theater-mode');var mp=document.querySelector('#movie_player');if(mp&&mp.classList.contains('ytp-fullscreen'))return'theater';return tm?'theater':'normal'}
function gvb(){if(!vc)return null;var isYT=window.location.hostname.includes('youtube');if(!isYT)return vc.getBoundingClientRect();var mode=dytm();if(mode==='fullscreen'){return vc.getBoundingClientRect()}var attempts=[{sel:'video',parent:false},{sel:'#movie_player video',parent:false},{sel:'.html5-main-video',parent:false},{sel:'div.html5-video-container video',parent:false}];for(var i=0;i<attempts.length;i++){var el=document.querySelector(attempts[i].sel);if(el){var rect=el.getBoundingClientRect();if(rect.width>0&&rect.height>0){return rect}}}return vc.getBoundingClientRect()}
function frd(){if(o){o.style.display='none';o.offsetHeight;o.style.display='block';o.style.transform='translateZ(0)';setTimeout(function(){o.style.transform=''},0)}}
function uop(force){if(!vc||!o)return;var now=Date.now();if(!force&&(ifu||now-udt<16))return;udt=now;ifu=1;try{var nvr=gvb();if(!nvr){ifu=0;return}var ifs=ifsm();var ytm=dytm();var cm=ifs?'fullscreen':(ytm||'normal');var wasFs=lvm==='fullscreen';var isExitingFs=wasFs&&!ifs;var hasChanged=Math.abs(nvr.width-vr.width)>1||Math.abs(nvr.height-vr.height)>1||Math.abs(nvr.top-vr.top)>1||Math.abs(nvr.left-vr.left)>1||lvm!==cm||force;if(!hasChanged){ifu=0;return}if(isExitingFs)pfs=1;vr=nvr;lvm=cm;var sp={x:window.pageXOffset||window.scrollX||0,y:window.pageYOffset||window.scrollY||0};o.style.position=ifs?'fixed':'absolute';o.style.width=Math.round(vr.width)+'px';o.style.height=Math.round(vr.height)+'px';if(ifs){o.style.top=Math.round(vr.top)+'px';o.style.left=Math.round(vr.left)+'px'}else{o.style.top=Math.round(vr.top+sp.y)+'px';o.style.left=Math.round(vr.left+sp.x)+'px'}o.style.zIndex=ifs?'2147483646':'10000';if(rp){rp.style.position=ifs?'fixed':'absolute';var rpTop=Math.max(10,vr.top-60);if(ifs){rp.style.left=Math.round(vr.left)+'px';rp.style.top=Math.round(rpTop)+'px'}else{rp.style.left=Math.round(vr.left+sp.x)+'px';rp.style.top=Math.round(rpTop+sp.y)+'px'}rp.style.zIndex=ifs?'2147483647':'10001'}if(!L){wi.value=Math.round(vr.width);hi.value=Math.round(vr.height)}M.forEach(function(m){if(m.rx&&m.ry){var nx=(m.rx/100)*vr.width;var ny=(m.ry/100)*vr.height;m.e.style.left=nx+'px';m.e.style.top=ny+'px';m.ci.querySelector('.x').value=Math.round(nx);m.ci.querySelector('.y').value=Math.round(ny)}});if(force||fuu||pmu||pfs){frd()}}catch(e){console.error('Update position error:',e)}finally{ifu=0;pmu=0}}
function iup(){fuu=1;pmu=1;clearTimeout(ut);clearTimeout(sut);uop(true);frd();requestAnimationFrame(function(){uop(true);frd();requestAnimationFrame(function(){uop(true);frd();setTimeout(function(){uop(true);frd();if(pfs){sut=setTimeout(function(){var stabilizeCount=0;var stabilize=setInterval(function(){uop(true);frd();stabilizeCount++;if(stabilizeCount>=5){clearInterval(stabilize);pfs=0}},50);},100)}fuu=0},100)})})}
function cup(){if(window.location.hostname.includes('youtube')){var cm=dytm();if(cm!==lvm){lvm=cm;clearTimeout(sut);iup()}}cz=Math.round((window.outerWidth/window.innerWidth)*100)/100;uz();var nvr=gvb();if(nvr&&(Math.abs(nvr.width-vr.width)>1||Math.abs(nvr.height-vr.height)>1||Math.abs(nvr.top-vr.top)>1||Math.abs(nvr.left-vr.left)>1)){uop()}raf=requestAnimationFrame(cup)}
function co(){o=ce('div');o.className='ba-o';document.body.appendChild(o);uop(true);o.addEventListener('click',function(e){if(!D&&sh){e.preventDefault();var r=o.getBoundingClientRect();am(e.clientX-r.left,e.clientY-r.top)}})}
function cc(){c=ce('div');c.className='ba-c';
var h=ce('h3'),t=ce('span');t.textContent='BA Coordinates';h.appendChild(t);
var ab=ce('button');ab.className='ba-b';ab.textContent='Add';h.appendChild(ab);c.appendChild(h);
var sc=ce('div');sc.className='ba-sc';
var rsc=ce('div');rsc.className='ba-ct';var rsl=ce('label');rsl.textContent='Ring Size:';rsc.appendChild(rsl);
var rsr=ce('div');rsr.className='ba-cr';var rss=ce('input');rss.type='range';rss.min='10';rss.max='500';rss.value='20';
var rsv=ce('span');rsv.textContent='20px';rsr.appendChild(rss);rsr.appendChild(rsv);rsc.appendChild(rsr);sc.appendChild(rsc);
var dsc=ce('div');dsc.className='ba-ct';var dsl=ce('label');dsl.textContent='Dot Size:';dsc.appendChild(dsl);
var dsr=ce('div');dsr.className='ba-cr';var dss=ce('input');dss.type='range';dss.min='1';dss.max='20';dss.value='3';
var dsv=ce('span');dsv.textContent='3px';dsr.appendChild(dss);dsr.appendChild(dsv);dsc.appendChild(dsr);sc.appendChild(dsc);
var rcc=ce('div');rcc.className='ba-ct';var rcl=ce('label');rcl.textContent='Ring Color:';rcc.appendChild(rcl);
var rcr=ce('div');rcr.className='ba-cr';var rci=ce('input');rci.type='color';rci.value='#41b4ff';
var rch=ce('span');rch.textContent='#41b4ff';rcr.appendChild(rci);rcr.appendChild(rch);rcc.appendChild(rcr);sc.appendChild(rcc);
var dcc=ce('div');dcc.className='ba-ct';var dcl=ce('label');dcl.textContent='Dot Color:';dcc.appendChild(dcl);
var dcr=ce('div');dcr.className='ba-cr';var dci=ce('input');dci.type='color';dci.value='#ff0000';
var dch=ce('span');dch.textContent='#ff0000';dcr.appendChild(dci);dcr.appendChild(dch);dcc.appendChild(dcr);sc.appendChild(dcc);
c.appendChild(sc);
var cl=ce('div');cl.className='ba-cl';c.appendChild(cl);
var ie=ce('div');ie.className='ba-ie';var ib=ce('button');ib.className='ba-b';ib.textContent='Import';
var eb=ce('button');eb.className='ba-b';eb.textContent='Export';ie.appendChild(ib);ie.appendChild(eb);c.appendChild(ie);
var bd=ce('div');bd.style.textAlign='right';bd.style.marginTop='10px';
var rb=ce('button');rb.className='ba-b';rb.textContent='Reset';
var cb=ce('button');cb.className='ba-b';cb.textContent='Close';bd.appendChild(rb);bd.appendChild(cb);c.appendChild(bd);
document.body.appendChild(c);
ab.onclick=function(){var r=o.getBoundingClientRect();am(r.width/2,r.height/2)};
rb.onclick=rm;cb.onclick=cx;ib.onclick=function(){cim();im.style.display='block'};eb.onclick=ex;
rss.oninput=function(){rs=parseInt(this.value);rsv.textContent=rs+'px';M.forEach(function(m){if(m.r)m.r.style.width=m.r.style.height=rs+'px'})};
dss.oninput=function(){ds=parseInt(this.value);dsv.textContent=ds+'px';M.forEach(function(m){if(m.d)m.d.style.width=m.d.style.height=ds+'px'})};
rci.oninput=function(){rc=this.value;rch.textContent=this.value;M.forEach(function(m){if(m.r)m.r.style.borderColor=rc})};
dci.oninput=function(){dc=this.value;dch.textContent=this.value;M.forEach(function(m){if(m.d)m.d.style.backgroundColor=dc})}}
function crp(){rp=ce('div');rp.className='ba-rp';
var l=ce('span');l.textContent='Resolution:';l.style.marginRight='10px';rp.appendChild(l);
wi=ce('input');wi.type='number';wi.value=Math.round(vr.width);wi.style.cssText='width:60px;margin-right:5px;padding:3px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:3px';
hi=ce('input');hi.type='number';hi.value=Math.round(vr.height);hi.style.cssText='width:60px;margin-right:10px;padding:3px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:3px';
var ap=ce('button');ap.textContent='Apply';ap.style.cssText='background:#2ecc71;color:white;border:none;padding:3px 8px;border-radius:3px;cursor:pointer';
var ll=ce('label');ll.style.cssText='margin-left:10px;display:flex;align-items:center;cursor:pointer';
lr=ce('input');lr.type='checkbox';lr.style.marginRight='5px';ll.appendChild(lr);ll.appendChild(document.createTextNode('Lock'));
rp.appendChild(wi);rp.appendChild(document.createTextNode(' × '));rp.appendChild(hi);rp.appendChild(ap);rp.appendChild(ll);
document.body.appendChild(rp);
ap.onclick=ar;lr.onchange=function(){L=this.checked};uop(true)}
function cz(){z=ce('div');z.className='ba-z';document.body.appendChild(z);uz()}
function cim(){if(im)return;im=ce('div');im.className='ba-im';
var mc=ce('div');mc.style.cssText='background:#fff;margin:10% auto;padding:20px;border-radius:8px;width:80%;max-width:700px';
var t=ce('h3');t.textContent='Import Coordinates';t.style.cssText='margin-top:0;color:#2c3e50';mc.appendChild(t);
var ta=ce('textarea');ta.id='ba-it';ta.style.cssText='width:100%;height:200px;margin-bottom:10px;padding:10px;border:1px solid #ddd;border-radius:5px;font-family:monospace';
ta.placeholder='Paste JSON/CFG content...';mc.appendChild(ta);
var bc=ce('div');bc.style.cssText='display:flex;justify-content:flex-end;gap:10px';
var cb=ce('button');cb.textContent='Cancel';cb.style.cssText='padding:8px 15px;background:#7f8c8d;color:white;border:none;border-radius:4px';
var ib=ce('button');ib.textContent='Import';ib.style.cssText='padding:8px 15px;background:#27ae60;color:white;border:none;border-radius:4px';
bc.appendChild(cb);bc.appendChild(ib);mc.appendChild(bc);im.appendChild(mc);document.body.appendChild(im);
cb.onclick=function(){im.style.display='none';ta.value=''};
ib.onclick=function(){pi()}}
function pi(){var t=document.getElementById('ba-it').value.trim();if(!t){alert('No data');return}
try{var j=JSON.parse(t);if(M.length>0&&confirm('Clear existing markers?'))rm();
if(j.ControlSchemes&&j.ControlSchemes[0]){ip(j.ControlSchemes[0])}else if(j.GameControls){ip(j)}else{alert('Invalid format')}
im.style.display='none';document.getElementById('ba-it').value=''}catch(e){alert('Import failed')}}
function ip(d){var gc=d.GameControls||[];var n=0;
gc.forEach(function(g){if(g.Type==="Tap"&&typeof g.X==='number'&&typeof g.Y==='number'){
var r=o.getBoundingClientRect();var x=(g.X/100)*r.width;var y=(g.Y/100)*r.height;
var id=am(x,y);if(g.Key){var m=M.find(function(m){return m.id==id});
if(m&&m.l)m.l.textContent='#'+id+' - '+g.Key}n++}});
alert('Imported '+n+' points')}
function ced(){if(ed)ed.remove();ed=ce('div');ed.className='ba-ed';
var t=ce('h3');t.textContent='Export Format';ed.appendChild(t);
var co=ce('div');co.className='ba-eo';co.setAttribute('data-format','cfg');
var ct=ce('h4');ct.textContent='CFG Format';co.appendChild(ct);
var cd=ce('p');cd.textContent='For BlueStacks import';co.appendChild(cd);ed.appendChild(co);
var jo=ce('div');jo.className='ba-eo';jo.setAttribute('data-format','json');
var jt=ce('h4');jt.textContent='JSON Format';jo.appendChild(jt);
var jd=ce('p');jd.textContent='Simple coordinate data';jo.appendChild(jd);ed.appendChild(jo);
var bc=ce('div');bc.className='ba-eb';var cb=ce('button');cb.className='ba-b';cb.textContent='Cancel';
cb.onclick=function(){ed.remove()};bc.appendChild(cb);ed.appendChild(bc);document.body.appendChild(ed);
co.onclick=function(){pe('cfg');ed.remove()};jo.onclick=function(){pe('json');ed.remove()}}
function pe(f){var d;if(f==='cfg'){d={MetaData:{},ControlSchemes:[{Name:"BA Coords",BuiltIn:false,Selected:true,
GameControls:M.map(function(m){return{Type:"Tap",X:m.rx,Y:m.ry,Key:'M'+(m.id)}})}]}}
else{d={GameControls:M.map(function(m){return{Type:"Tap",X:m.rx,Y:m.ry}})}}
var j=JSON.stringify(d,null,2);var b=new Blob([j],{type:'application/json'});
var u=URL.createObjectURL(b);var a=ce('a');a.href=u;a.download='ba_coords.'+(f==='cfg'?'cfg':'json');
a.click();URL.revokeObjectURL(u)}
function ex(){if(M.length===0){alert('No markers');return}ced()}
function ar(){var w=parseInt(wi.value)||vr.width;var h=parseInt(hi.value)||vr.height;
if(w<1||h<1){alert('Invalid dimensions');return}
vr={width:w,height:h,top:vr.top,left:vr.left,right:vr.left+w,bottom:vr.top+h};
o.style.width=w+'px';o.style.height=h+'px';
M.forEach(function(m){var currentX=parseFloat(m.e.style.left);var currentY=parseFloat(m.e.style.top);
m.rx=(currentX/w*100).toFixed(2);m.ry=(currentY/h*100).toFixed(2);
var rxInput=m.ci.querySelector('.rx');var ryInput=m.ci.querySelector('.ry');
if(rxInput)rxInput.value=m.rx;if(ryInput)ryInput.value=m.ry});
if(!L)um()}
function um(){if(L)return;var r=o.getBoundingClientRect();
M.forEach(function(m){var x=(m.rx/100)*r.width;var y=(m.ry/100)*r.height;
m.e.style.left=x+'px';m.e.style.top=y+'px';
m.ci.querySelector('.x').value=Math.round(x);m.ci.querySelector('.y').value=Math.round(y)})}
function am(x,y){C++;var m=ce('div');m.className='ba-m';m.style.left=x+'px';m.style.top=y+'px';m.setAttribute('data-id',C);
var d=ce('div');d.className='ba-d';d.style.width=ds+'px';d.style.height=ds+'px';d.style.backgroundColor=dc;
var r=ce('div');r.className='ba-r';r.style.width=rs+'px';r.style.height=rs+'px';r.style.borderColor=rc;
var l=ce('div');l.className='ba-l';l.textContent='#'+C;
m.appendChild(r);m.appendChild(d);m.appendChild(l);o.appendChild(m);
m.onmousedown=function(e){e.preventDefault();e.stopPropagation();D=1;S=this;
var rect=m.getBoundingClientRect();dx=e.clientX-(rect.left+rect.width/2);dy=e.clientY-(rect.top+rect.height/2)};
var or=o.getBoundingClientRect();var rx=(x/or.width*100).toFixed(2);var ry=(y/or.height*100).toFixed(2);
var ci=ce('div');ci.className='ba-ci';ci.setAttribute('data-id',C);
var h=ce('h4');var hs=ce('span');hs.textContent='Marker #'+C;h.appendChild(hs);
var db=ce('button');db.className='ba-b ba-del';db.textContent='×';db.setAttribute('data-id',C);
h.appendChild(db);ci.appendChild(h);
var ic=ce('div');ic.className='ba-i';
var xg=ce('div');xg.className='ba-ig';var xl=ce('label');xl.textContent='X:';xg.appendChild(xl);
var xi=ce('input');xi.type='number';xi.className='x';xi.value=Math.round(x);xi.setAttribute('data-id',C);
xg.appendChild(xi);ic.appendChild(xg);
var yg=ce('div');yg.className='ba-ig';var yl=ce('label');yl.textContent='Y:';yg.appendChild(yl);
var yi=ce('input');yi.type='number';yi.className='y';yi.value=Math.round(y);yi.setAttribute('data-id',C);
yg.appendChild(yi);ic.appendChild(yg);
var rxg=ce('div');rxg.className='ba-ig';var rxl=ce('label');rxl.textContent='Ratio X:';rxg.appendChild(rxl);
var rxi=ce('input');rxi.type='number';rxi.className='rx';rxi.value=rx;rxi.setAttribute('data-id',C);
rxg.appendChild(rxi);ic.appendChild(rxg);
var ryg=ce('div');ryg.className='ba-ig';var ryl=ce('label');ryl.textContent='Ratio Y:';ryg.appendChild(ryl);
var ryi=ce('input');ryi.type='number';ryi.className='ry';ryi.value=ry;ryi.setAttribute('data-id',C);
ryg.appendChild(ryi);ic.appendChild(ryg);ci.appendChild(ic);
c.querySelector('.ba-cl').appendChild(ci);
db.onclick=function(){dm(parseInt(this.getAttribute('data-id')))};
xi.oninput=function(){var id=parseInt(this.getAttribute('data-id'));var mo=M.find(function(m){return m.id===id});
if(!mo)return;var nx=parseFloat(this.value);mo.e.style.left=nx+'px';
var r=o.getBoundingClientRect();mo.rx=(nx/r.width*100).toFixed(2);rxi.value=mo.rx};
yi.oninput=function(){var id=parseInt(this.getAttribute('data-id'));var mo=M.find(function(m){return m.id===id});
if(!mo)return;var ny=parseFloat(this.value);mo.e.style.top=ny+'px';
var r=o.getBoundingClientRect();mo.ry=(ny/r.height*100).toFixed(2);ryi.value=mo.ry};
rxi.oninput=function(){var id=parseInt(this.getAttribute('data-id'));var mo=M.find(function(m){return m.id===id});
if(!mo)return;mo.rx=parseFloat(this.value);var r=o.getBoundingClientRect();
var nx=mo.rx*r.width/100;mo.e.style.left=nx+'px';xi.value=Math.round(nx)};
ryi.oninput=function(){var id=parseInt(this.getAttribute('data-id'));var mo=M.find(function(m){return m.id===id});
if(!mo)return;mo.ry=parseFloat(this.value);var r=o.getBoundingClientRect();
var ny=mo.ry*r.height/100;mo.e.style.top=ny+'px';yi.value=Math.round(ny)};
M.push({id:C,e:m,r:r,d:d,l:l,ci:ci,x:x,y:y,rx:parseFloat(rx),ry:parseFloat(ry)});return C}
function dm(id){var i=M.findIndex(function(m){return m.id===id});if(i===-1)return;
var m=M[i];if(m.e.parentNode)m.e.parentNode.removeChild(m.e);
if(m.ci.parentNode)m.ci.parentNode.removeChild(m.ci);M.splice(i,1)}
function rm(){M.forEach(function(m){if(m.e.parentNode)m.e.parentNode.removeChild(m.e)});
M=[];C=0;cl(c.querySelector('.ba-cl'))}
function cx(){window.baCT=0;if(o)o.remove();if(c)c.remove();if(rp)rp.remove();
if(im)im.remove();if(z)z.remove();if(ed)ed.remove();if(ro)ro.disconnect();if(mo)mo.disconnect();
if(yro)yro.disconnect();if(raf)cancelAnimationFrame(raf);clearTimeout(ut);clearTimeout(ytut);clearTimeout(sut);
document.removeEventListener('keydown',kd);document.removeEventListener('keyup',ku);
document.removeEventListener('fullscreenchange',fsc);document.removeEventListener('webkitfullscreenchange',fsc);
document.removeEventListener('scroll',sc);window.removeEventListener('resize',wr);
window.removeEventListener('yt-navigate-finish',ytnf);
window.removeEventListener('transitionend',tse);
window.removeEventListener('yt-player-updated',ytpu);
document.removeEventListener('yt-action',yta);s.remove()}
function kd(e){if(e.key==='Shift'){sh=1;if(o){o.style.cursor='crosshair';o.style.pointerEvents='all'}}else if(e.key==='t'&&window.location.hostname.includes('youtube')&&!e.ctrlKey&&!e.altKey&&!e.metaKey){setTimeout(function(){var cm=dytm();if(cm!==lvm){lvm=cm;clearTimeout(sut);iup()}},50)}}
function ku(e){if(e.key==='Shift'){sh=0;if(o){o.style.cursor='default';o.style.pointerEvents='none'}}}
function fsc(){var wasFs=lvm==='fullscreen';var isFs=ifsm();if(wasFs&&!isFs)pfs=1;iup()}
function sc(){if(!ifsm())uop()}
function wr(){uop()}
function tse(e){if(e.target&&(e.target.id==='movie_player'||e.target.classList.contains('ytd-watch-flexy'))){iup()}}
function ytpu(){iup()}
function yta(e){if(e.detail&&(e.detail.actionName==='yt-player-updated'||e.detail.actionName==='yt-fullscreen-update'||e.detail.actionName==='yt-theater-mode-change'||e.detail.actionName==='yt-set-theater-mode-enabled'||e.detail.actionName==='yt-set-theater-mode')){clearTimeout(sut);iup()}}
function ytnf(){clearTimeout(ytut);ytut=setTimeout(function(){var nv=fv();if(nv&&nv!==vc){vc=nv;if(ro){ro.disconnect();ro.observe(vc);ro.observe(document.body)}if(yro&&vc.parentNode){yro.disconnect();yro.observe(vc.parentNode,{attributes:true,childList:true,subtree:true})}uop(true)}},100)}
document.addEventListener('keydown',kd);document.addEventListener('keyup',ku);
document.addEventListener('fullscreenchange',fsc);document.addEventListener('webkitfullscreenchange',fsc);
document.addEventListener('scroll',sc);window.addEventListener('resize',wr);
window.addEventListener('yt-navigate-finish',ytnf);
window.addEventListener('transitionend',tse);
window.addEventListener('yt-player-updated',ytpu);
document.addEventListener('yt-action',yta);
document.addEventListener('mousemove',function(e){if(D&&S){var r=o.getBoundingClientRect();
var nx=e.clientX-r.left-dx;var ny=e.clientY-r.top-dy;
nx=Math.max(0,Math.min(r.width,nx));ny=Math.max(0,Math.min(r.height,ny));
S.style.left=nx+'px';S.style.top=ny+'px';
var id=parseInt(S.getAttribute('data-id'));var m=M.find(function(m){return m.id==id});
if(m){m.rx=(nx/r.width*100).toFixed(2);m.ry=(ny/r.height*100).toFixed(2);
m.ci.querySelector('.x').value=Math.round(nx);m.ci.querySelector('.y').value=Math.round(ny);
m.ci.querySelector('.rx').value=m.rx;m.ci.querySelector('.ry').value=m.ry}}});
document.addEventListener('mouseup',function(){D=0;S=null});
co();cc();crp();cz();
if(window.ResizeObserver){ro=new ResizeObserver(function(entries){var needsUpdate=false;entries.forEach(function(entry){if(entry.target===vc||entry.target===document.body){needsUpdate=true}});if(needsUpdate){uop()}});ro.observe(vc);ro.observe(document.body)}
if(window.MutationObserver&&window.location.hostname.includes('youtube')){mo=new MutationObserver(function(ml){var needsUpdate=false;ml.forEach(function(m){if(m.type==='attributes'){var attrName=m.attributeName;if(attrName==='theater'||attrName==='theater-requested'||attrName==='fullscreen'||attrName==='class'||attrName==='style'||attrName==='width'||attrName==='height'||attrName==='theater-mode'||attrName==='size'){needsUpdate=true}}else if(m.type==='childList'){needsUpdate=true}});if(needsUpdate){clearTimeout(sut);iup()}});var ytpc=document.querySelector('ytd-watch-flexy');if(ytpc){mo.observe(ytpc,{attributes:true,attributeFilter:['theater','theater-requested','fullscreen','class','style','theater-mode','size'],childList:true,subtree:true})}var mp=document.querySelector('#movie_player');if(mp){mo.observe(mp,{attributes:true,attributeFilter:['class','style','width','height'],childList:false,subtree:false})}var ytp=document.querySelector('ytd-app');if(ytp){mo.observe(ytp,{attributes:true,attributeFilter:['masthead-hidden','scrolling'],childList:false})}}
if(window.MutationObserver&&window.location.hostname.includes('youtube')&&vc&&vc.parentNode){yro=new MutationObserver(function(){iup()});yro.observe(vc.parentNode,{attributes:true,childList:true,subtree:true})}
var wt=setInterval(function(){if(window.location.hostname.includes('youtube')){var ytpc=document.querySelector('ytd-watch-flexy');if(ytpc&&mo&&!ytpc.hasAttribute('ba-observed')){ytpc.setAttribute('ba-observed','true');mo.observe(ytpc,{attributes:true,attributeFilter:['theater','theater-requested','fullscreen','class','style','theater-mode','size'],childList:true,subtree:true})}var mp=document.querySelector('#movie_player');if(mp&&mo&&!mp.hasAttribute('ba-observed')){mp.setAttribute('ba-observed','true');mo.observe(mp,{attributes:true,attributeFilter:['class','style','width','height']})}var tb=document.querySelector('button.ytp-size-button');if(tb&&!tb.hasAttribute('ba-observed')){tb.setAttribute('ba-observed','true');tb.addEventListener('click',function(){setTimeout(function(){var cm=dytm();if(cm!==lvm){lvm=cm;clearTimeout(sut);iup()}},50)})}}},1000);
raf=requestAnimationFrame(cup);
})();`;

            /**
             * Get Container for Bookmarklet Code
             * ================================================================================
             * Retrieves the container element where the bookmarklet will be inserted.
             */
            var bookmarkletCodeBlock = document.getElementById('bookmarkletCode');
            
            /**
             * Clear Container Content
             * ================================================================================
             * Removes all existing child elements from the container using DOM manipulation.
             * This ensures a clean slate before inserting new content.
             */
            while (bookmarkletCodeBlock.firstChild) {
                bookmarkletCodeBlock.removeChild(bookmarkletCodeBlock.firstChild);
            }
            
            /**
             * Create Instructions Section
             * ================================================================================
             * Creates the instructions and information about the bookmarklet.
             * Uses DOM methods to build the structure instead of innerHTML.
             */
            var instructions = document.createElement('div');
            
            // Title paragraph with strong element
            var instructionsTitle = document.createElement('p');
            var strongElement = document.createElement('strong');
            strongElement.textContent = 'How to Use This Bookmarklet:';
            instructionsTitle.appendChild(strongElement);
            instructions.appendChild(instructionsTitle);
            
            // Drag instructions paragraph
            var dragInstructions = document.createElement('p');
            dragInstructions.textContent = 'Drag this link to your bookmarks bar:';
            instructions.appendChild(dragInstructions);
            
            // Feature description
            var featureTitle = document.createElement('p');
            featureTitle.textContent = 'This tool lets you place markers on videos for Blue Archive coordinates by:';
            instructions.appendChild(featureTitle);
            
            /**
             * Create Feature List
             * ================================================================================
             * Builds an unordered list of features using DOM manipulation.
             * Special handling for NEW features to make them bold.
             */
            var featureList = document.createElement('ul');
            
            // Array of features to display
            var features = [
                'NEW: Fixed resolution ratio calculations when manually changing dimensions!',
                'NEW: Instant updates for ALL YouTube mode changes - no interaction needed!',
                'Add labels to markers for easy identification',
                'Automatically adjusts when you zoom the page',
                'Customize marker colors and sizes',
                'Hold SHIFT and click to place markers',
                'Import/Export in CFG format for BlueStacks',
                'Shows current zoom level in top-left corner',
                'Works on YouTube and most video sites',
            ];
            
            // Create list items for each feature
            features.forEach(function(feature) {
                var listItem = document.createElement('li');
                // Check if feature starts with 'NEW' to make it bold
                if (feature.startsWith('NEW')) {
                    var strongNew = document.createElement('strong');
                    strongNew.textContent = feature;
                    listItem.appendChild(strongNew);
                } else {
                    listItem.textContent = feature;
                }
                featureList.appendChild(listItem);
            });
            
            instructions.appendChild(featureList);
            
            /**
             * Create Bookmarklet Link
             * ================================================================================
             * Creates the draggable bookmarklet link that users can add to their bookmarks.
             * The href contains the entire bookmarklet code, properly encoded.
             */
            var bookmarkletLink = document.createElement('a');
            bookmarkletLink.href = 'javascript:' + encodeURIComponent(bookmarkletCode.replace(/\s+/g, ' ').trim());
            bookmarkletLink.textContent = 'Blue Archive Coordinates Bookmarklet v1.4';
            bookmarkletLink.className = 'bookmarklet-link';
            bookmarkletLink.setAttribute('draggable', 'true');
            
            /**
             * Append Elements to Container
             * ================================================================================
             * Adds all created elements to the bookmarklet code container.
             */
            bookmarkletCodeBlock.appendChild(instructions);
            bookmarkletCodeBlock.appendChild(bookmarkletLink);
        });
    </script>
</body>

</html>